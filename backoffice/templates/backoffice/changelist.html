{% extends "backoffice/base.html" %}
{% load humanize %}

{% block backoffice_title %}{{ item.verbose_name_plural|capfirst }}{% endblock %}

{% block backoffice_content %}
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-body-tertiary d-flex flex-wrap justify-content-between align-items-center gap-2">
      <div class="fw-semibold">{{ item.verbose_name_plural|capfirst }}</div>
      <div class="d-flex flex-wrap gap-2">
        {% if can_add %}
          <a class="btn btn-sm btn-primary" href="{% url 'backoffice:add' item.app_label item.model_name %}">Add</a>
        {% endif %}
      </div>
    </div>
    <div class="card-body">
      <form method="get" class="row g-2 align-items-end mb-3">
        <div class="col-12 col-md-6">
          <label class="form-label mb-1 small">Search</label>
          <input class="form-control form-control-sm" type="text" name="q" value="{{ request.GET.q|default:'' }}">
          <div class="form-text">Uses the model’s `search_fields` from engineering admin.</div>
        </div>
        <div class="col-12 col-md-3">
          <button class="btn btn-sm btn-outline-secondary" type="submit">Apply</button>
          <a class="btn btn-sm btn-link" href="{% url 'backoffice:changelist' item.app_label item.model_name %}">Clear</a>
        </div>
      </form>

      <form method="post">
        {% csrf_token %}

        {% if action_choices %}
          <div class="row g-2 align-items-end mb-3">
            <div class="col-12 col-md-6">
              <label class="form-label mb-1 small">Bulk action</label>
              <select class="form-select form-select-sm" name="action">
                <option value="">Select…</option>
                {% for a in action_choices %}
                  <option value="{{ a.name }}">{{ a.label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-3">
              <button class="btn btn-sm btn-outline-primary" type="submit">Run</button>
            </div>
            <div class="col-12">
              <div class="form-text">Select rows below and run an action (from Django admin).</div>
            </div>
          </div>
        {% endif %}

        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead>
              <tr>
                <th style="width: 36px;">
                  <input class="form-check-input" type="checkbox" id="boSelectAll">
                </th>
                {% for h in headers %}
                  <th>{{ h.label }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for r in rows %}
                <tr>
                  <td>
                    <input class="form-check-input bo-row-select" type="checkbox" name="_selected_action" value="{{ r.obj.pk }}">
                  </td>
                  {% for c in r.cells %}
                    <td>{{ c }}</td>
                  {% endfor %}
                </tr>
              {% empty %}
                <tr>
                  <td colspan="{{ headers|length|add:1 }}" class="text-muted">No results.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </form>
    </div>
  </div>

  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
    <div class="small text-muted">
      Page {{ cl.page_num|add:1 }} of {{ cl.paginator.num_pages }} · {{ cl.result_count|intcomma }} result(s)
    </div>
    <div class="btn-group btn-group-sm" role="group" aria-label="Pagination">
      {% if cl.page_num > 0 %}
        <a class="btn btn-outline-secondary"
           href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}p={{ cl.page_num|add:-1 }}">Prev</a>
      {% else %}
        <button class="btn btn-outline-secondary" disabled>Prev</button>
      {% endif %}
      {% if cl.page_num|add:1 < cl.paginator.num_pages %}
        <a class="btn btn-outline-secondary"
           href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}p={{ cl.page_num|add:1 }}">Next</a>
      {% else %}
        <button class="btn btn-outline-secondary" disabled>Next</button>
      {% endif %}
    </div>
  </div>

  <script>
    (function () {
      var all = document.getElementById("boSelectAll");
      if (!all) return;
      all.addEventListener("change", function () {
        var on = !!all.checked;
        document.querySelectorAll(".bo-row-select").forEach(function (cb) {
          cb.checked = on;
        });
      });
    })();
  </script>
{% endblock %}

